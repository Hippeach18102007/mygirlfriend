<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Th·ª≠ Th√°ch T√¨nh Y√™u: Flappy Heart</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #333;
            font-family: 'Nunito', sans-serif;
            overflow: hidden; /* Ch·∫∑n cu·ªôn trang */
            touch-action: none; /* Ch·∫∑n zoom tr√™n ƒëi·ªán tho·∫°i */
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
            overflow: hidden;
            cursor: pointer;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* ƒê·ªÉ click xuy√™n qua UI v√†o canvas */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        #score-board {
            position: absolute;
            top: 20px;
            font-size: 3rem;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
        }

        #start-screen, #game-over-screen, #win-screen {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 4px solid #ff4081;
            pointer-events: auto; /* Cho ph√©p b·∫•m n√∫t */
        }

        h1 { color: #c2185b; margin: 0 0 10px 0; }
        p { color: #333; font-size: 1.1em; }

        .btn {
            background: #ff4081; color: white; border: none;
            padding: 15px 30px; font-size: 1.2em; border-radius: 50px;
            cursor: pointer; margin-top: 15px; font-weight: bold;
            box-shadow: 0 5px 15px rgba(255, 64, 129, 0.4);
            transition: transform 0.2s;
        }
        .btn:active { transform: scale(0.95); }

        .hidden { display: none !important; }

        /* Hi·ªáu ·ª©ng m√¢y bay */
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: moveCloud linear infinite;
        }
        @keyframes moveCloud { from { transform: translateX(110vw); } to { transform: translateX(-20vw); } }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="score-board">0</div>

    <div id="ui-layer">
        <div id="start-screen">
            <h1>Flappy Heart ‚ù§Ô∏è</h1>
            <p>Em h√£y ƒë∆∞a tr√°i tim v∆∞·ª£t qua s√≥ng gi√≥ nh√©!</p>
            <p><b>M·ª•c ti√™u:</b> 30 ƒëi·ªÉm (T∆∞·ª£ng tr∆∞ng 1 th√°ng)</p>
            <p style="color: red; font-size: 0.9em;">(C·∫£nh b√°o: Game r·∫•t kh√≥!)</p>
            <button class="btn" onclick="startGame()">B·∫Øt ƒë·∫ßu ch∆°i</button>
        </div>

        <div id="game-over-screen" class="hidden">
            <h1>√îi kh√¥ng! üíî</h1>
            <p>Tr√°i tim ƒë√£ va v√†o kh√≥ khƒÉn r·ªìi.</p>
            <p>ƒêi·ªÉm c·ªßa em: <span id="final-score">0</span></p>
            <p id="mock-message" style="font-style: italic; color: #555;"></p>
            <button class="btn" onclick="resetGame()">Th·ª≠ l·∫°i ƒëi b√©</button>
        </div>

        <div id="win-screen" class="hidden">
            <h1>üéâ CH√öC M·ª™NG V·ª¢! üéâ</h1>
            <p>Em th·∫≠t s·ª± ki√™n tr√¨ lu√¥n √°! 30 ng√†y ƒë√£ qua!</p>
            <p>ƒê√¢y l√† ph·∫ßn th∆∞·ªüng c·ªßa em:</p>
            <div style="background: #eee; padding: 10px; border-radius: 5px; margin: 10px 0; font-weight: bold; color: #d32f2f;">
                VOUCHER: "BAT-CU-DIEU-GI-EM-MUON"
            </div>
            <p>Ch·ª•p m√†n h√¨nh l·∫°i g·ª≠i anh nh√©! ‚ù§Ô∏è</p>
            <button class="btn" onclick="location.href='/'">V·ªÅ trang ch·ªß</button>
        </div>
    </div>

    <div class="cloud" style="width: 100px; height: 40px; top: 10%; animation-duration: 15s;"></div>
    <div class="cloud" style="width: 150px; height: 60px; top: 30%; animation-duration: 25s;"></div>
    <div class="cloud" style="width: 80px; height: 30px; top: 60%; animation-duration: 10s;"></div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // UI Elements
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const winScreen = document.getElementById('win-screen');
    const scoreEl = document.getElementById('score-board');
    const finalScoreEl = document.getElementById('final-score');
    const mockMsgEl = document.getElementById('mock-message');

    // Game Variables
    let gameLoop;
    let frames = 0;
    let score = 0;
    let isGameOver = false;
    let isPlaying = false;
    const WIN_SCORE = 30; // ƒêI·ªÇM CHI·∫æN TH·∫ÆNG

    // Responsive Canvas
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // ƒê·ªëi t∆∞·ª£ng Tr√°i Tim (Ng∆∞·ªùi ch∆°i)
    const heart = {
        x: 50,
        y: 150,
        radius: 15,
        velocity: 0,
        gravity: 0.25, // Tr·ªçng l·ª±c (C√†ng cao c√†ng r∆°i nhanh - Kh√≥)
        jump: 4.6,     // L·ª±c n·∫£y l√™n

        draw: function() {
            ctx.fillStyle = "#ff4081";
            ctx.beginPath();
            // V·∫Ω h√¨nh tr√°i tim ƒë∆°n gi·∫£n b·∫±ng math
            let x = this.x;
            let y = this.y;
            let r = this.radius;
            ctx.moveTo(x, y + r / 4);
            ctx.quadraticCurveTo(x, y, x + r / 2, y);
            ctx.quadraticCurveTo(x + r, y, x + r, y + r / 2);
            ctx.quadraticCurveTo(x + r, y + r, x, y + r * 1.5);
            ctx.quadraticCurveTo(x - r, y + r, x - r, y + r / 2);
            ctx.quadraticCurveTo(x - r, y, x - r / 2, y);
            ctx.quadraticCurveTo(x, y, x, y + r / 4);
            ctx.fill();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 2;
            ctx.stroke();
        },

        update: function() {
            this.velocity += this.gravity;
            this.y += this.velocity;

            // Ch·∫°m ƒë·∫•t
            if (this.y + this.radius > canvas.height) {
                this.y = canvas.height - this.radius;
                gameOver();
            }
            // Ch·∫°m tr·∫ßn
            if (this.y - this.radius < 0) {
                this.y = this.radius;
                this.velocity = 0;
            }
        },

        flap: function() {
            this.velocity = -this.jump;
        }
    };

    // Qu·∫£n l√Ω C·ªôt (Ch∆∞·ªõng ng·∫°i v·∫≠t)
    const pipes = {
        position: [],
        width: 60, // Chi·ªÅu r·ªông c·ªôt
        gap: 160,  // Khe h·ªü (C√†ng nh·ªè c√†ng kh√≥)
        dx: 2.5,   // T·ªëc ƒë·ªô di chuy·ªÉn (C√†ng cao c√†ng kh√≥)

        draw: function() {
            ctx.fillStyle = "#4caf50"; // M√†u xanh l√°
            ctx.strokeStyle = "#2e7d32";
            ctx.lineWidth = 3;

            for(let i = 0; i < this.position.length; i++) {
                let p = this.position[i];
                let topY = p.y;
                let bottomY = p.y + this.gap;

                // C·ªôt tr√™n
                ctx.fillRect(p.x, 0, this.width, topY);
                ctx.strokeRect(p.x, 0, this.width, topY);

                // C·ªôt d∆∞·ªõi
                ctx.fillRect(p.x, bottomY, this.width, canvas.height - bottomY);
                ctx.strokeRect(p.x, bottomY, this.width, canvas.height - bottomY);
            }
        },

        update: function() {
            // Th√™m c·ªôt m·ªõi m·ªói 120 frames (kho·∫£ng 2 gi√¢y)
            if(frames % 120 === 0) {
                // Random v·ªã tr√≠ khe h·ªü
                let min = canvas.height * 0.1;
                let max = canvas.height * 0.7; // Ch·ª´a ch·ªó cho khe h·ªü
                let y = Math.floor(Math.random() * (max - min + 1) + min);

                this.position.push({ x: canvas.width, y: y, passed: false });
            }

            for(let i = 0; i < this.position.length; i++) {
                let p = this.position[i];
                p.x -= this.dx; // Di chuy·ªÉn sang tr√°i

                // X·ª≠ l√Ω va ch·∫°m
                // Logic va ch·∫°m h√¨nh ch·ªØ nh·∫≠t vs h√¨nh tr√≤n (ƒë∆°n gi·∫£n h√≥a th√†nh h·ªôp va ch·∫°m)
                let heartLeft = heart.x - heart.radius + 5; // +5 ƒë·ªÉ hitbox nh·ªè h∆°n ch√∫t cho d·ªÖ th·ªü
                let heartRight = heart.x + heart.radius - 5;
                let heartTop = heart.y; // ƒê·ªânh tim
                let heartBottom = heart.y + heart.radius * 1.5; // ƒêu√¥i tim

                // Check va ch·∫°m c·ªôt tr√™n ho·∫∑c c·ªôt d∆∞·ªõi
                if (heartRight > p.x && heartLeft < p.x + this.width) {
                    if (heartTop < p.y || heartBottom > p.y + this.gap) {
                        gameOver();
                    }
                }

                // C·ªông ƒëi·ªÉm
                if(p.x + this.width < heart.x && !p.passed) {
                    score++;
                    scoreEl.innerText = score;
                    p.passed = true;

                    // √Çm thanh ƒÉn ƒëi·ªÉm (tu·ª≥ ch·ªçn)
                    // new Audio('point.mp3').play().catch(()=>{});

                    // TƒÇNG ƒê·ªò KH√ì: C·ª© m·ªói 5 ƒëi·ªÉm, t·ªëc ƒë·ªô tƒÉng l√™n ch√∫t x√≠u
                    if(score % 5 === 0) this.dx += 0.2;

                    // WIN GAME
                    if(score >= WIN_SCORE) {
                        gameWin();
                    }
                }

                // X√≥a c·ªôt ƒë√£ ƒëi qua
                if(p.x + this.width < 0) {
                    this.position.shift();
                }
            }
        },

        reset: function() {
            this.position = [];
            this.dx = 2.5; // Reset t·ªëc ƒë·ªô
        }
    };

    // V√≤ng l·∫∑p Game
    function loop() {
        if (!isPlaying) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        pipes.update();
        pipes.draw();

        heart.update();
        heart.draw();

        frames++;

        if (!isGameOver) {
            gameLoop = requestAnimationFrame(loop);
        }
    }

    // Controls
    function startGame() {
        startScreen.classList.add('hidden');
        gameOverScreen.classList.add('hidden');
        winScreen.classList.add('hidden');
        scoreEl.classList.remove('hidden');

        // Reset state
        heart.y = 150;
        heart.velocity = 0;
        pipes.reset();
        score = 0;
        scoreEl.innerText = score;
        frames = 0;
        isGameOver = false;
        isPlaying = true;

        loop();
    }

    function resetGame() {
        startGame();
    }

    function gameOver() {
        isGameOver = true;
        isPlaying = false;
        cancelAnimationFrame(gameLoop);

        // C√°c c√¢u c√† kh·ªãa khi thua
        const messages = [
            "Ch∆∞a g√¨ ƒë√£ b·ªè cu·ªôc r·ªìi sao? üòú",
            "C·ªë l√™n em y√™u, m·ªõi c√≥ x√≠u m√†!",
            "Anh bi·∫øt l√† kh√≥, nh∆∞ng y√™u anh c√≤n kh√≥ h∆°n c∆°!",
            "L·∫°i n√†o, t·∫≠p trung v√†o!",
            "Thua r·ªìi l√™u l√™u üòù"
        ];
        mockMsgEl.innerText = messages[Math.floor(Math.random() * messages.length)];

        finalScoreEl.innerText = score;
        scoreEl.classList.add('hidden');
        gameOverScreen.classList.remove('hidden');
    }

    function gameWin() {
        isGameOver = true;
        isPlaying = false;
        cancelAnimationFrame(gameLoop);

        winScreen.classList.remove('hidden');

        // G·ª≠i th√¥ng b√°o chi·∫øn th·∫Øng v·ªÅ Discord (·∫®n danh)
        // B·∫°n c√≥ th·ªÉ th√™m fetch API ·ªü ƒë√¢y n·∫øu mu·ªën h·ªá th·ªëng t·ª± b√°o v·ªÅ
    }

    // Input Handling (Mouse & Touch)
    window.addEventListener('keydown', function(e) {
        if (e.code === 'Space' || e.code === 'ArrowUp') {
            if(isPlaying) heart.flap();
        }
    });

    // Ch·∫°m m√†n h√¨nh ho·∫∑c click chu·ªôt ƒë·ªÅu bay
    document.getElementById('game-container').addEventListener('mousedown', function() {
        if(isPlaying) heart.flap();
    });

    document.getElementById('game-container').addEventListener('touchstart', function(e) {
        e.preventDefault(); // Ch·∫∑n zoom/scroll
        if(isPlaying) heart.flap();
    }, {passive: false});

</script>
</body>
</html>