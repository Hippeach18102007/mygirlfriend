<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒê·∫°i Chi·∫øn T√¨nh Y√™u (Fixed) üî´</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background-color: #2c3e50; overflow: hidden; font-family: 'Bungee', cursive; touch-action: none; }
        #lobby { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; color: white; }
        .btn-select { padding: 20px 40px; margin: 20px; font-size: 1.5rem; border: 4px solid white; cursor: pointer; font-family: inherit; transition: transform 0.2s; }
        .btn-select:active { transform: scale(0.95); }
        .btn-boy { background: #3498db; color: white; }
        .btn-girl { background: #e91e63; color: white; }
        canvas { display: block; background: url('https://www.transparenttextures.com/patterns/cubes.png') #34495e; }
        .hud { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; pointer-events: none; }
        .hp-bar { width: 40%; height: 30px; background: #555; border: 3px solid white; position: relative; }
        .hp-fill { height: 100%; transition: width 0.2s; }
        #hp-boy { background: #3498db; width: 100%; }
        #hp-girl { background: #e91e63; width: 100%; }
        .controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; }
        .btn-ctrl { width: 70px; height: 70px; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 50%; color: white; font-size: 30px; display: flex; justify-content: center; align-items: center; user-select: none; }
        .btn-shoot { background: #e74c3c; border-color: #e74c3c; width: 90px; height: 90px; }
        .btn-ctrl:active { background: rgba(255,255,255,0.5); }
        #winScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 200; color: #f1c40f; text-shadow: 0 0 20px orange; font-size: 3rem; }
    </style>
</head>
<body>

<div class="hud">
    <div style="color:#3498db">ANH ƒê·ª®C <div class="hp-bar"><div id="hp-boy" class="hp-fill"></div></div></div>
    <div style="text-align:right; color:#e91e63">V·ª¢ Y√äU <div class="hp-bar"><div id="hp-girl" class="hp-fill"></div></div></div>
</div>

<div id="lobby">
    <h1>ƒê·∫†I CHI·∫æN T√åNH Y√äU üî´</h1>
    <button class="btn-select btn-boy" onclick="startGame('BOY')">üë¶ ANH (PHE XANH)</button>
    <button class="btn-select btn-girl" onclick="startGame('GIRL')">üëß EM (PHE H·ªíNG)</button>
    <a href="/" style="color: #aaa; margin-top: 20px; text-decoration: none;">‚¨Ö V·ªÅ trang ch·ªß</a>
</div>

<div id="winScreen">
    <h1 id="winnerText">WINNER!</h1>
    <button class="btn-select btn-boy" onclick="resetGame()">CH∆†I L·∫†I</button>
</div>

<canvas id="gameCanvas"></canvas>

<div class="controls">
    <div style="display:flex; flex-direction:column; gap:10px;">
        <div class="btn-ctrl" ontouchstart="moving=-1" ontouchend="moving=0">‚¨ÜÔ∏è</div>
        <div class="btn-ctrl" ontouchstart="moving=1" ontouchend="moving=0">‚¨áÔ∏è</div>
    </div>
    <div class="btn-ctrl btn-shoot" onclick="shoot()">üî•</div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let stompClient = null;
    let myRole = null;
    let moving = 0;
    let isGameOver = false;

    const playerSize = 60;
    const speed = 7;
    const bulletSpeed = 12;

    let boy = { x: 50, y: canvas.height/2, hp: 100 };
    let girl = { x: canvas.width - 50 - playerSize, y: canvas.height/2, hp: 100 };
    let bullets = [];

    function startGame(role) {
        myRole = role;
        document.getElementById('lobby').style.display = 'none';
        connect();
    }

    function connect() {
        const socket = new SockJS('/ws-game');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        stompClient.connect({}, function () {
            stompClient.subscribe('/topic/shooter', function (res) {
                handleNetworkData(JSON.parse(res.body));
            });
            requestAnimationFrame(update);
        });
    }

    function sendData(action, yVal, bulletY = 0) {
        if(stompClient && stompClient.connected) {
            stompClient.send("/app/shooter/action", {}, JSON.stringify({
                role: myRole, action: action, y: yVal, bulletY: bulletY
            }));
        }
    }

    function resetGame() {
        sendData('RESET', 0);
    }

    function handleNetworkData(data) {
        // ƒê·ªìng b·ªô m√°u t·ª´ Server (ƒê√¢y l√† ngu·ªìn ch√¢n l√Ω duy nh·∫•t)
        if (data.hpBoy !== undefined) {
            boy.hp = data.hpBoy;
            girl.hp = data.hpGirl;
            updateHealthUI();
            checkWin();
        }

        if (data.action === 'RESET') {
            isGameOver = false;
            document.getElementById('winScreen').style.display = 'none';
            bullets = [];
        }

        // ƒê·ªìng b·ªô v·ªã tr√≠ ƒë·ªëi th·ªß
        if (data.role === 'BOY' && myRole === 'GIRL') {
            boy.y = data.y;
            if (data.action === 'SHOOT') spawnBullet(boy.x + playerSize, data.bulletY, 1, 'BOY');
        }
        else if (data.role === 'GIRL' && myRole === 'BOY') {
            girl.y = data.y;
            if (data.action === 'SHOOT') spawnBullet(girl.x, data.bulletY, -1, 'GIRL');
        }
    }

    function spawnBullet(x, y, dir, owner) {
        bullets.push({ x: x, y: y + playerSize/2, dir: dir, owner: owner });
    }

    function shoot() {
        if(isGameOver) return;
        const me = myRole === 'BOY' ? boy : girl;
        // B·∫Øn ·ªü m√°y m√¨nh tr∆∞·ªõc cho m∆∞·ª£t
        if (myRole === 'BOY') spawnBullet(boy.x + playerSize, boy.y, 1, 'BOY');
        else spawnBullet(girl.x, girl.y, -1, 'GIRL');

        // G·ª≠i l·ªánh l√™n server ƒë·ªÉ b√°o m√°y kia b·∫Øn theo
        sendData('SHOOT', me.y, me.y);
    }

    function update() {
        if (isGameOver) {
            requestAnimationFrame(update); // V·∫´n v·∫Ω nh∆∞ng kh√¥ng update logic
            return;
        }

        // 1. Di chuy·ªÉn b·∫£n th√¢n
        const me = myRole === 'BOY' ? boy : girl;
        if (moving !== 0) {
            me.y += moving * speed;
            if(me.y < 0) me.y = 0;
            if(me.y > canvas.height - playerSize) me.y = canvas.height - playerSize;
            sendData('MOVE', me.y);
        }

        // 2. Di chuy·ªÉn ƒë·∫°n & Va ch·∫°m
        for (let i = bullets.length - 1; i >= 0; i--) {
            let b = bullets[i];
            b.x += b.dir * bulletSpeed;

            if (b.x < 0 || b.x > canvas.width) {
                bullets.splice(i, 1);
                continue;
            }

            // QUAN TR·ªåNG: Ch·ªâ ng∆∞·ªùi b·∫Øn m·ªõi c√≥ quy·ªÅn t√≠nh HIT (ƒë·ªÉ ƒë·∫£m b·∫£o c√¥ng b·∫±ng)
            // N·∫øu m√¨nh b·∫Øn tr√∫ng ƒë·ªëi th·ªß -> B√°o Server
            if (b.owner === myRole) {
                let target = (myRole === 'BOY') ? girl : boy;
                let targetRole = (myRole === 'BOY') ? 'GIRL' : 'BOY';

                if (checkCollision(b, target)) {
                    bullets.splice(i, 1);
                    // G·ª≠i tin nh·∫Øn: "ƒê·ªëi th·ªß (TargetRole) b·ªã d√≠nh ƒë·∫°n (HIT)"
                    sendData('HIT', 0, 0);
                    // L∆∞u √Ω: role trong sendData ·ªü ƒë√¢y ta s·∫Ω s·ª≠a l·∫°i m·ªôt ch√∫t ·ªü logic g·ª≠i:
                    // Thay v√¨ s·ª≠a h√†m sendData, ta g·ª≠i role l√† ƒë·ªëi th·ªß ƒë·ªÉ server tr·ª´ m√°u ƒë·ªëi th·ªß
                    // Nh∆∞ng ƒë·ªÉ ƒë∆°n gi·∫£n, server ƒëang tr·ª´ m√°u d·ª±a tr√™n role g·ª≠i l√™n.
                    // S·ª≠a l·∫°i logic: G·ª≠i role c·ªßa NG∆Ø·ªúI B·ªä B·∫ÆN l√™n server.

                    stompClient.send("/app/shooter/action", {}, JSON.stringify({
                        role: targetRole, // Ng∆∞·ªùi b·ªã b·∫Øn
                        action: 'HIT',
                        y: 0, bulletY: 0
                    }));
                }
            }
        }

        draw();
        requestAnimationFrame(update);
    }

    function checkCollision(bullet, player) {
        return (bullet.x > player.x && bullet.x < player.x + playerSize &&
            bullet.y > player.y && bullet.y < player.y + playerSize);
    }

    function checkWin() {
        if (boy.hp <= 0 || girl.hp <= 0) {
            isGameOver = true;
            const winner = boy.hp > 0 ? "ANH ƒê·ª®C TH·∫ÆNG!" : "V·ª¢ Y√äU TH·∫ÆNG!";
            document.getElementById('winnerText').innerText = winner;
            document.getElementById('winScreen').style.display = 'flex';
        }
    }

    function updateHealthUI() {
        document.getElementById('hp-boy').style.width = boy.hp + '%';
        document.getElementById('hp-girl').style.width = girl.hp + '%';
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = "50px Arial";
        ctx.fillText("üë¶", boy.x, boy.y + 50);
        ctx.fillText("üëß", girl.x, girl.y + 50);

        bullets.forEach(b => {
            ctx.font = "30px Arial";
            ctx.fillText(b.owner === 'BOY' ? "üíô" : "üíò", b.x, b.y);
        });
    }

    // PC Controls
    document.addEventListener('keydown', (e) => {
        if(e.key === 'ArrowUp' || e.key === 'w') moving = -1;
        if(e.key === 'ArrowDown' || e.key === 's') moving = 1;
        if(e.key === ' ') shoot();
    });
    document.addEventListener('keyup', (e) => {
        if(['ArrowUp','ArrowDown','w','s'].includes(e.key)) moving = 0;
    });

</script>
</body>
</html>