<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Giai ƒêi·ªáu T√¨nh Y√™u üéπ</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0; padding: 0;
      background: #222;
      font-family: 'Quicksand', sans-serif;
      overflow: hidden; /* Ch·∫∑n cu·ªôn */
      touch-action: none;
    }

    #game-container {
      position: relative;
      width: 100vw; height: 100vh;
      background: #111;
      display: flex;
      justify-content: center;
    }

    /* 4 L√†n ƒë∆∞·ªùng */
    .lane {
      width: 25%; height: 100%;
      border-right: 1px solid rgba(255,255,255,0.1);
      position: relative;
    }
    .lane:last-child { border-right: none; }

    /* N·ªët nh·∫°c */
    .tile {
      position: absolute;
      width: 100%; height: 120px;
      background: linear-gradient(to bottom, #ff69b4, #d81b60);
      border-radius: 5px;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(255, 20, 147, 0.6);
      z-index: 10;
    }

    .tile.clicked {
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      transition: opacity 0.2s, background 0.1s;
    }

    /* Thanh k·∫ª ngang d∆∞·ªõi c√πng (V·∫°ch ƒë√≠ch) */
    .line {
      position: absolute; bottom: 20%; left: 0; width: 100%; height: 2px;
      background: rgba(255,255,255,0.3); pointer-events: none;
    }

    /* UI */
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }

    #score {
      position: absolute; top: 20px;
      font-size: 3em; color: white;
      text-shadow: 0 0 10px #ff69b4;
      z-index: 100;
    }

    #start-screen, #game-over-screen {
      background: rgba(0,0,0,0.85);
      padding: 40px; border-radius: 20px;
      text-align: center; color: white;
      pointer-events: auto;
      border: 2px solid #ff69b4;
    }

    button {
      background: #d81b60; color: white; border: none;
      padding: 15px 40px; font-size: 1.2em; border-radius: 50px;
      margin-top: 20px; cursor: pointer; font-weight: bold;
    }

    .hidden { display: none !important; }

    /* Hi·ªáu ·ª©ng b·∫•m */
    .effect {
      position: absolute; width: 100%; height: 100%;
      background: rgba(255,255,255,0.2);
      animation: flash 0.2s ease-out;
    }
    @keyframes flash { from {opacity: 1;} to {opacity: 0;} }
  </style>
</head>
<body>

<div id="game-container">
  <div class="lane" id="lane-0" onclick="handleLaneClick(0)"></div>
  <div class="lane" id="lane-1" onclick="handleLaneClick(1)"></div>
  <div class="lane" id="lane-2" onclick="handleLaneClick(2)"></div>
  <div class="lane" id="lane-3" onclick="handleLaneClick(3)"></div>
  <div class="line"></div>
</div>

<div id="score">0</div>

<div id="ui-layer">
  <div id="start-screen">
    <h1 style="color: #ff69b4;">üéπ Magic Piano</h1>
    <p>B·∫•m v√†o c√°c n·ªët nh·∫°c m√†u h·ªìng.</p>
    <p>ƒê·ª´ng ƒë·ªÉ n·ªët tr√¥i qua v·∫°ch k·∫ª!</p>
    <button onclick="startGame()">B·∫Øt ƒë·∫ßu</button>
  </div>

  <div id="game-over-screen" class="hidden">
    <h1>Sai ƒëi·ªáu r·ªìi! üò≠</h1>
    <p>ƒêi·ªÉm: <span id="final-score">0</span></p>
    <p>Anh v·∫´n y√™u em d√π em h√°t sai nh·ªãp üòò</p>
    <button onclick="startGame()">Ch∆°i l·∫°i</button>
    <button onclick="location.href='/'" style="background: #555;">V·ªÅ trang ch·ªß</button>
  </div>
</div>

<script>
  const lanes = [
    document.getElementById('lane-0'),
    document.getElementById('lane-1'),
    document.getElementById('lane-2'),
    document.getElementById('lane-3')
  ];
  const scoreEl = document.getElementById('score');
  const startScreen = document.getElementById('start-screen');
  const gameOverScreen = document.getElementById('game-over-screen');
  const finalScoreEl = document.getElementById('final-score');

  let isPlaying = false;
  let score = 0;
  let speed = 3; // T·ªëc ƒë·ªô r∆°i ban ƒë·∫ßu
  let gameLoop;
  let spawnLoop;
  let tiles = [];

  // --- √ÇM THANH (WEB AUDIO API) ---
  // T·∫°o √¢m thanh Piano gi·∫£ l·∫≠p b·∫±ng s√≥ng Sine
  let audioCtx;

  function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  // C√°c t·∫ßn s·ªë n·ªët nh·∫°c (C4, D4, E4, F4, G4, A4, B4, C5...)
  const notes = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25];

  function playSound() {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    // Ch·ªçn n·ªët ng·∫´u nhi√™n trong gam C Major ƒë·ªÉ nghe cho √™m tai
    const freq = notes[Math.floor(Math.random() * notes.length)];

    osc.type = 'sine'; // S√≥ng h√¨nh sin (nghe √™m gi·ªëng s√°o/piano ƒëi·ªán)
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

    // Hi·ªáu ·ª©ng √¢m l∆∞·ª£ng (Fade out)
    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

    osc.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    osc.start();
    osc.stop(audioCtx.currentTime + 0.5);
  }

  // --- LOGIC GAME ---

  function spawnTile() {
    if (!isPlaying) return;

    const laneIndex = Math.floor(Math.random() * 4);
    const tile = document.createElement('div');
    tile.classList.add('tile');
    tile.style.top = '-150px'; // B·∫Øt ƒë·∫ßu ·ªü tr√™n c√πng m√†n h√¨nh
    tile.dataset.clicked = "false";

    // Th√™m v√†o m·∫£ng qu·∫£n l√Ω
    tiles.push({
      element: tile,
      y: -150,
      lane: laneIndex
    });

    lanes[laneIndex].appendChild(tile);
  }

  function update() {
    if (!isPlaying) return;

    // X√≥a c√°c tile ƒë√£ b·ªã h·ªßy kh·ªèi DOM
    tiles = tiles.filter(t => {
      if (t.removeMe) {
        t.element.remove();
        return false;
      }
      return true;
    });

    for (let i = 0; i < tiles.length; i++) {
      let t = tiles[i];

      // Di chuy·ªÉn xu·ªëng
      t.y += speed;
      t.element.style.top = t.y + 'px';

      // Ki·ªÉm tra n·∫øu tr√¥i qua ƒë√°y m√†n h√¨nh m√† ch∆∞a click -> Thua
      if (t.y > window.innerHeight) {
        if (t.element.dataset.clicked === "false") {
          gameOver();
          return;
        } else {
          t.removeMe = true; // ƒê√£ click v√† tr√¥i h·∫øt m√†n h√¨nh th√¨ x√≥a
        }
      }
    }

    gameLoop = requestAnimationFrame(update);
  }

  // X·ª≠ l√Ω click v√†o l√†n
  window.handleLaneClick = function(laneIndex) {
    if (!isPlaying) return;

    // T√¨m tile th·∫•p nh·∫•t trong l√†n n√†y ch∆∞a ƒë∆∞·ª£c click
    // S·∫Øp x·∫øp ƒë·ªÉ l·∫•y c√°i ·ªü d∆∞·ªõi c√πng (y l·ªõn nh·∫•t)
    const tilesInLane = tiles.filter(t => t.lane === laneIndex && t.element.dataset.clicked === "false");
    tilesInLane.sort((a, b) => b.y - a.y);

    if (tilesInLane.length > 0) {
      const target = tilesInLane[0];

      // Ki·ªÉm tra xem ƒë√£ v√†o v√πng b·∫•m ƒë∆∞·ª£c ch∆∞a (g·∫ßn ƒë√°y m√†n h√¨nh 1 ch√∫t th√¨ t·ªët, nh∆∞ng cho ph√©p b·∫•m s·ªõm)
      // ·ªû ƒë√¢y cho ph√©p b·∫•m b·∫•t c·ª© l√∫c n√†o mi·ªÖn l√† tile ƒëang hi·ªán

      target.element.classList.add('clicked');
      target.element.dataset.clicked = "true";

      // Hi·ªáu ·ª©ng
      playSound();
      score++;
      scoreEl.textContent = score;

      // TƒÉng t·ªëc ƒë·ªô
      if (score % 10 === 0) speed += 0.5;

      // Hi·ªáu ·ª©ng flash cho l√†n
      const flash = document.createElement('div');
      flash.classList.add('effect');
      lanes[laneIndex].appendChild(flash);
      setTimeout(() => flash.remove(), 200);

    } else {
      // B·∫•m nh·∫ßm v√†o ch·ªó tr·ªëng -> Thua
      gameOver();
    }
  };

  // H·ªó tr·ª£ c·∫£m ·ª©ng ƒëa ƒëi·ªÉm t·ªët h∆°n (Touchstart)
  // Thay th·∫ø onclick m·∫∑c ƒë·ªãnh ƒë·ªÉ nhanh h∆°n tr√™n mobile
  lanes.forEach((lane, index) => {
    lane.addEventListener('touchstart', (e) => {
      e.preventDefault(); // Ch·∫∑n zoom
      handleLaneClick(index);
    }, {passive: false});
  });

  function startGame() {
    initAudio();
    // Reset
    tiles.forEach(t => t.element.remove());
    tiles = [];
    score = 0;
    speed = 4; // T·ªëc ƒë·ªô ban ƒë·∫ßu
    scoreEl.textContent = score;
    isPlaying = true;

    startScreen.classList.add('hidden');
    gameOverScreen.classList.add('hidden');

    update();

    // Spawn tile li√™n t·ª•c
    clearInterval(spawnLoop);
    // T·ªëc ƒë·ªô sinh tile d·ª±a v√†o t·ªëc ƒë·ªô r∆°i (ƒë·ªÉ kho·∫£ng c√°ch ƒë·ªÅu nhau)
    spawnLoop = setInterval(spawnTile, 600); // 0.6s ra 1 n·ªët
  }

  function gameOver() {
    isPlaying = false;
    cancelAnimationFrame(gameLoop);
    clearInterval(spawnLoop);
    finalScoreEl.textContent = score;
    gameOverScreen.classList.remove('hidden');

    // √Çm thanh thua cu·ªôc (ti·∫øng th·∫•p)
    if(audioCtx) {
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.frequency.value = 150;
      osc.type = 'sawtooth';
      g.gain.value = 0.5;
      g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1);
      osc.connect(g); g.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 1);
    }
  }

</script>
</body>
</html>