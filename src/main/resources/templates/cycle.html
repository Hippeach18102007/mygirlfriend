<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch Theo D√µi Chu K·ª≥ üìÖ</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #fce4ec; /* N·ªÅn h·ªìng ph·∫•n */
            font-family: 'Nunito', sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        h1 { color: #c2185b; margin-bottom: 10px; }

        /* Ph·∫ßn ƒëi·ªÅu khi·ªÉn */
        .controls {
            background: white; padding: 15px 30px; border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 30px;
            display: flex; gap: 10px; align-items: center;
        }
        input[type="date"] { padding: 8px; border-radius: 8px; border: 1px solid #ccc; font-family: inherit;}
        button {
            background: #e91e63; color: white; border: none; padding: 8px 20px;
            border-radius: 20px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        button:hover { background: #c2185b; }

        /* Ch√∫ th√≠ch */
        .legend { display: flex; gap: 20px; margin-bottom: 20px; font-size: 0.9rem; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 15px; height: 15px; border-radius: 50%; }
        .dot.period { background: #ff4081; box-shadow: 0 0 5px #ff4081; }
        .dot.ovulation { background: #ffeb3b; border: 1px solid #fbc02d; }

        /* Khung l∆∞·ªõi ch·ª©a 12 th√°ng */
        .year-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* T·ª± ƒë·ªông xu·ªëng d√≤ng */
            gap: 20px;
            width: 100%; max-width: 1200px;
        }

        /* Th·∫ª t·ª´ng th√°ng */
        .month-card {
            background: white; border-radius: 15px; padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-top: 5px solid #e91e63; /* ƒêi·ªÉm nh·∫•n m√†u h·ªìng */
        }
        .month-title {
            text-align: center; font-weight: bold; color: #444;
            margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;
        }

        /* L∆∞·ªõi ng√†y trong th√°ng (7 c·ªôt) */
        .days-grid {
            display: grid; grid-template-columns: repeat(7, 1fr);
            text-align: center; gap: 2px;
        }
        .day-name { font-size: 0.8rem; color: #888; font-weight: bold; margin-bottom: 5px; }

        .day {
            aspect-ratio: 1; /* H√¨nh vu√¥ng */
            display: flex; justify-content: center; align-items: center;
            font-size: 0.9rem; border-radius: 50%;
            cursor: default; position: relative;
        }

        .day:hover { background-color: #f5f5f5; }

        /* -- M√ÄU S·∫ÆC ƒê√ÅNH D·∫§U -- */
        .day.is-period {
            background-color: #ff80ab; color: white; font-weight: bold;
        }
        .day.is-period::after { content: 'ü©∏'; font-size: 0.6rem; position: absolute; bottom: 2px; }

        .day.is-ovulation {
            background-color: #fff9c4; border: 2px solid #fbc02d; color: #f57f17; font-weight: bold;
        }
        .day.is-ovulation::after { content: 'ü•ö'; font-size: 0.6rem; position: absolute; bottom: 2px; }

        .day.today { border: 2px solid #2196f3; color: #2196f3; font-weight: bold; }
        .day.empty { pointer-events: none; } /* √î tr·ªëng ƒë·∫ßu th√°ng */

    </style>
</head>
<body>

<a href="/" style="position: absolute; top: 20px; left: 20px; text-decoration: none; color: #c2185b; font-weight: bold;">‚¨Ö Trang ch·ªß</a>

<h1>L·ªãch S·ª©c Kh·ªèe Cho N√†ng üå∏</h1>

<div class="controls">
    <label>Ng√†y b·∫Øt ƒë·∫ßu k·ª≥ kinh g·∫ßn nh·∫•t:</label>
    <input type="date" id="startDate" value="2025-12-20">
    <button onclick="renderFullYear()">üìÖ T·∫°o L·ªãch Ngay</button>
</div>

<div class="legend">
    <div class="legend-item"><div class="dot period"></div> Ng√†y ƒë√®n ƒë·ªè (D·ª± ki·∫øn)</div>
    <div class="legend-item"><div class="dot ovulation"></div> Ng√†y r·ª•ng tr·ª©ng (Th·ª• thai cao)</div>
</div>

<div class="year-grid" id="calendarContainer">
</div>

<script>
    const weekDays = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];

    // H√†m ti·ªán √≠ch: C·ªông ng√†y
    function addDays(dateStr, days) {
        const result = new Date(dateStr);
        result.setDate(result.getDate() + days);
        return result;
    }

    // H√†m ti·ªán √≠ch: Format date th√†nh chu·ªói yyyy-mm-dd ƒë·ªÉ so s√°nh
    function formatDateISO(date) {
        return date.toISOString().split('T')[0];
    }

    // H√†m ch√≠nh: G·ªçi API v√† v·∫Ω l·ªãch
    async function renderFullYear() {
        const startInput = document.getElementById('startDate').value;
        if (!startInput) return alert("Ch·ªçn ng√†y ƒëi anh ∆°i!");

        // 1. L·∫•y d·ªØ li·ªáu chu k·ª≥ t·ª´ Server
        const response = await fetch(`/api/cycle-data?startDate=${startInput}`);
        const cycleEvents = await response.json();

        // 2. Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu API th√†nh danh s√°ch c√°c ng√†y c·∫ßn t√¥ m√†u
        // Map: '2025-12-20' -> 'period'
        const specialDays = {};

        cycleEvents.forEach(evt => {
            const start = new Date(evt.startDate);
            // ƒê√°nh d·∫•u 5 ng√†y ƒë√®n ƒë·ªè
            for (let i = 0; i < 5; i++) {
                const d = new Date(start);
                d.setDate(start.getDate() + i);
                specialDays[formatDateISO(d)] = 'period';
            }
            // ƒê√°nh d·∫•u ng√†y r·ª•ng tr·ª©ng
            specialDays[evt.ovulationDate] = 'ovulation';
        });

        // 3. V·∫Ω l·ªãch 12 th√°ng (B·∫Øt ƒë·∫ßu t·ª´ th√°ng ng∆∞·ªùi d√πng ch·ªçn)
        const container = document.getElementById('calendarContainer');
        container.innerHTML = ''; // X√≥a c≈©

        const startDate = new Date(startInput);
        let currentMonth = startDate.getMonth(); // 0 - 11
        let currentYear = startDate.getFullYear();

        // V√≤ng l·∫∑p 12 th√°ng
        for (let i = 0; i < 12; i++) {
            const monthDiv = createMonthHTML(currentYear, currentMonth, specialDays);
            container.appendChild(monthDiv);

            // TƒÉng th√°ng
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
        }
    }

    function createMonthHTML(year, month, specialDays) {
        const card = document.createElement('div');
        card.className = 'month-card';

        // Ti√™u ƒë·ªÅ th√°ng
        const monthName = `Th√°ng ${month + 1} / ${year}`;
        const header = document.createElement('div');
        header.className = 'month-title';
        header.innerText = monthName;
        card.appendChild(header);

        // L∆∞·ªõi ng√†y
        const grid = document.createElement('div');
        grid.className = 'days-grid';

        // 1. V·∫Ω ti√™u ƒë·ªÅ th·ª© (T2, T3...)
        weekDays.forEach(day => {
            const d = document.createElement('div');
            d.className = 'day-name';
            d.innerText = day;
            grid.appendChild(d);
        });

        // 2. T√≠nh to√°n ng√†y
        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 (CN) -> 6 (T7)
        const daysInMonth = new Date(year, month + 1, 0).getDate(); // L·∫•y s·ªë ng√†y c·ªßa th√°ng

        // 3. V·∫Ω c√°c √¥ tr·ªëng ƒë·∫ßu th√°ng (n·∫øu m√πng 1 kh√¥ng ph·∫£i ch·ªß nh·∫≠t)
        for (let i = 0; i < firstDayOfMonth; i++) {
            const empty = document.createElement('div');
            empty.className = 'day empty';
            grid.appendChild(empty);
        }

        // 4. V·∫Ω c√°c ng√†y (1 -> 30/31)
        for (let d = 1; d <= daysInMonth; d++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'day';
            dayCell.innerText = d;

            // T·∫°o string 'yyyy-mm-dd' chu·∫©n ƒë·ªÉ so s√°nh v·ªõi danh s√°ch specialDays
            // L∆∞u √Ω: month trong JS b·∫Øt ƒë·∫ßu t·ª´ 0, c·∫ßn +1. PadStart ƒë·ªÉ th√™m s·ªë 0 ƒë·∫±ng tr∆∞·ªõc (01, 02...)
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

            // Ki·ªÉm tra xem ng√†y n√†y c√≥ s·ª± ki·ªán g√¨ kh√¥ng
            if (specialDays[dateString] === 'period') {
                dayCell.classList.add('is-period');
                dayCell.title = "Ng√†y d√¢u";
            } else if (specialDays[dateString] === 'ovulation') {
                dayCell.classList.add('is-ovulation');
                dayCell.title = "R·ª•ng tr·ª©ng";
            }

            // Highlight ng√†y h√¥m nay
            const today = new Date();
            if (d === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayCell.classList.add('today');
            }

            grid.appendChild(dayCell);
        }

        card.appendChild(grid);
        return card;
    }

    // T·ª± ƒë·ªông ch·∫°y khi load trang
    window.onload = renderFullYear;
</script>

</body>
</html>