<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gửi Chị, Người Em Thương</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Quicksand:wght@300..700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #c2185b;
            --secondary-color: #e91e63;
        }
        body { margin: 0; padding: 20px; font-family: 'Quicksand', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-image: linear-gradient(to top, rgba(194, 24, 91, 0.2), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1502673530728-f79b41d2b5ea?q=80&w=2070&auto-format&fit=crop'); background-repeat: no-repeat; background-position: center center; background-size: cover; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .letter-container { background-color: #faf6f0; padding: 40px 50px; border-radius: 15px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3); max-width: 600px; width: 90%; text-align: center; border: 1px solid rgba(255, 255, 255, 0.2); }
        h1, h2, .signature { font-family: 'Playfair Display', serif; }
        h1 { font-size: 2.5em; color: var(--primary-color); margin-bottom: 20px; }
        h2 { color: #555; font-size: 1.5em; }
        .message { font-size: 1.1em; line-height: 1.8; color: #333; text-align: left; margin-bottom: 30px; }
        .signature { font-style: italic; font-size: 1.3em; color: #555; text-align: right; margin-top: 20px; }

        @keyframes fade-in-up { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .letter-container { animation: fade-in-up 0.8s forwards cubic-bezier(0.2, 0.8, 0.2, 1); }
        .heart { animation: beat 1.5s infinite, fade-in-up 0.8s 0.2s forwards cubic-bezier(0.2, 0.8, 0.2, 1); opacity: 0; }
        h1 { animation: fade-in-up 0.8s 0.4s forwards cubic-bezier(0.2, 0.8, 0.2, 1); opacity: 0; }
        .message { animation: fade-in-up 0.8s 0.6s forwards cubic-bezier(0.2, 0.8, 0.2, 1); opacity: 0; }
        .signature { animation: fade-in-up 0.8s 0.8s forwards cubic-bezier(0.2, 0.8, 0.2, 1); opacity: 0; }
        .reasons-section { animation: fade-in-up 0.8s 0.9s forwards cubic-bezier(0.2, 0.8, 0.2, 1); opacity: 0; }
        .memories-link { animation: fade-in-up 0.8s 1.0s forwards cubic-bezier(0.2, 0.8, 0.2, 1); opacity: 0; }
        .reply-section { animation: fade-in-up 0.8s 1.1s forwards cubic-bezier(0.2, 0.8, 0.2, 1); opacity: 0; }

        .heart { font-size: 3em; color: var(--secondary-color); }
        @keyframes beat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

        .reasons-section { text-align: center; margin-top: 40px; padding: 30px 0; border-top: 1px dashed #ccc; border-bottom: 1px dashed #ccc; }
        #reason-button { background-color: var(--secondary-color); color: white; border: none; padding: 15px 30px; font-size: 1.1em; font-family: 'Quicksand', sans-serif; font-weight: bold; border-radius: 50px; cursor: pointer; margin-bottom: 20px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(225, 30, 99, 0.4); }
        #reason-button:hover { background-color: var(--primary-color); transform: scale(1.05); }
        #reason-display { font-family: 'Playfair Display', serif; font-style: italic; font-size: 1.4em; color: #333; min-height: 50px; transition: opacity 0.5s; }
        #reason-display.fade { opacity: 0; }

        .memories-link { display: flex; justify-content: center; gap: 10px; margin-top: 30px; padding-bottom: 30px; flex-wrap: wrap; }
        .memory-button { background-color: transparent; color: var(--primary-color); border: 2px solid var(--primary-color); padding: 10px 20px; font-size: 1em; font-family: 'Quicksand', sans-serif; font-weight: bold; border-radius: 50px; cursor: pointer; text-decoration: none; transition: all 0.3s; }
        .memory-button:hover { background-color: var(--primary-color); color: white; transform: scale(1.05); }

        .reply-section { margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 30px; }
        textarea { width: 100%; min-height: 100px; padding: 15px; font-family: 'Quicksand', sans-serif; font-size: 1em; border-radius: 8px; border: 1px solid #ddd; margin-top: 10px; box-sizing: border-box; transition: box-shadow 0.3s; }
        textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 10px rgba(225, 30, 99, 0.2); }
        #submitButton { background-color: var(--secondary-color); color: white; border: none; padding: 12px 25px; font-size: 1.1em; font-family: 'Quicksand', sans-serif; font-weight: bold; border-radius: 50px; cursor: pointer; margin-top: 15px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(225, 30, 99, 0.4); }
        #submitButton:hover { background-color: var(--primary-color); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(225, 30, 99, 0.5); }
        #submitButton:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }
        input[type="file"] { margin-top: 15px; border: 1px dashed var(--primary-color); padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; background-color: #fff0f5; cursor: pointer; }
        #statusMessage { margin-top: 15px; padding: 10px; border-radius: 5px; font-weight: bold; display: none; }
        #statusMessage.success { background-color: #dff0d8; color: #3c763d; }
        #statusMessage.error { background-color: #f2dede; color: #a94442; }

        .youtube-player-hidden { position: absolute; width: 1px; height: 1px; overflow: hidden; opacity: 0; z-index: -1; }
        #volume-toggle { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background-color: rgba(0, 0, 0, 0.5); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; z-index: 1001; transition: background-color 0.3s, transform 0.3s; }
        #volume-toggle:hover { background-color: var(--secondary-color); transform: scale(1.1); }
        /* --- CSS CHO PHẦN QUÀ 20-10 --- */
        .gift-section {
            text-align: center;
            margin-top: 30px; /* Điều chỉnh khoảng cách nếu cần */
            animation: fade-in-up 0.8s 0.95s forwards cubic-bezier(0.2, 0.8, 0.2, 1); /* Hơi trễ hơn reason */
            opacity: 0;
        }

        #gift-button {
            background: linear-gradient(45deg, #ffc107, #ff9800); /* Màu vàng cam */
            color: #333; /* Chữ màu tối */
            border: none;
            padding: 18px 35px; /* Nút to hơn một chút */
            font-size: 1.3em;
            font-family: 'Quicksand', sans-serif;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.5);
            text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.5);
        }

        #gift-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 25px rgba(255, 152, 0, 0.7);
        }

        /* --- CSS CHO POPUP (MODAL) QUÀ --- */
        .modal {
            display: none; /* Mặc định ẩn */
            position: fixed;
            z-index: 1001; /* Đè lên nút loa */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(145deg, var(--primary-color, #c2185b), var(--secondary-color, #e91e63));
            padding: 30px 40px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid #fff;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
            width: 90%;
            max-width: 450px;
            position: relative;
            animation: zoom-in 0.5s forwards;
            color: white;
        }

        .close-modal-button {
            position: absolute;
            top: 10px;
            right: 20px;
            color: #fff;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal-button:hover {
            color: #eee;
        }

        .modal-content h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2.2em;
            margin-top: 0;
            margin-bottom: 15px;
            color: #ffd700; /* Màu vàng gold */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        .gift-image {
            max-width: 80%;
            height: auto;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .gift-message {
            font-size: 1.2em;
            line-height: 1.7;
        }

        @keyframes zoom-in {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>

<div class="letter-container">
    <div class="heart">&#10084;</div>
    <h1>Gửi chị, <span th:text="${tenNguoiNhan}"></span>!</h1>
    <p class="message" th:utext="${loiNhanYeuThuong}"></p>
    <p class="signature">Thân thương,<br><span th:text="${tenNguoiGui}"></span></p>

    <div class="reasons-section">
        <button id="reason-button">Nhấn vào đây đi chị!</button>
        <p id="reason-display">Mỗi lần nhấn là một bất ngờ đó 😊</p>
    </div>
    <div class="gift-section">
        <button id="gift-button">🎁 Mở quà 20-10! 🎁</button>
    </div>
    <div class="memories-link">
        <a th:href="@{/dem-ngay}" class="memory-button">Đếm Ngày Yêu 💖</a>
        <a th:href="@{/ky-niem}" class="memory-button">Xem Kỷ Niệm &#128149;</a>
        <a th:href="@{/nghe-nhac}" class="memory-button">Nghe Nhạc 🎶</a>
        <a th:href="@{/vong-quay}" class="memory-button">Vòng Quay Yêu Thương 🎁</a>
        <a th:href="@{/ghep-hinh}" class="memory-button">Ghép Hình Kỷ Niệm</a>
    </div>

    <div class="reply-section">
        <h2>Chị có muốn nhắn lại gì cho em không?</h2>
        <form id="replyForm" th:action="@{/gui-chi}" method="post" enctype="multipart/form-data">
            <textarea name="reply_message" placeholder="Viết lời nhắn của chị ở đây..." required></textarea>
            <input type="file" name="imageFile" accept="image/*">
            <button id="submitButton" type="submit">&#10084; Gửi cho em</button>
        </form>
        <div id="statusMessage"></div>
    </div>
</div>

<div id="volume-toggle">🔇</div>
<script>
    // --- PHẦN TOÀN CỤC CHO YOUTUBE PLAYER ---
    let player;
    let isMuted = true;
    let isPlayerStarted = false;

    function onYouTubeIframeAPIReady() {
        if (document.getElementById('youtube-player')) {
            player = new YT.Player('youtube-player');
        } else {
            console.warn("YouTube player iframe element not found. Music player will not start.");
        }
    }

    // --- PHẦN XỬ LÝ CHÍNH KHI TRANG TẢI XONG ---
    document.addEventListener("DOMContentLoaded", function() {

        // --- 1. Code xử lý gửi form ---
        const form = document.getElementById('replyForm');
        const statusMessage = document.getElementById('statusMessage');
        const submitButton = document.getElementById('submitButton');

        if (form && statusMessage && submitButton) {
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                submitButton.disabled = true;
                submitButton.textContent = 'Đang gửi...';
                const formData = new FormData(form);
                fetch(form.action, { method: 'POST', body: formData })
                    .then(response => {
                        if (!response.ok) { return response.text().then(text => { throw new Error(text || 'Đã có lỗi xảy ra.'); }); }
                        return response.text();
                    })
                    .then(successMessage => {
                        statusMessage.textContent = successMessage;
                        statusMessage.className = 'success';
                        statusMessage.style.display = 'block';
                        form.reset();
                    })
                    .catch(error => {
                        statusMessage.textContent = 'Lỗi: ' + error.message;
                        statusMessage.className = 'error';
                        statusMessage.style.display = 'block';
                    })
                    .finally(() => {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '&#10084; Gửi cho em';
                    });
            });
        } else {
            console.warn("Reply form elements not found.");
        }

        // --- 2. Code cho chức năng "Lý do yêu thương" ---
        const reasonButton = document.getElementById('reason-button');
        const reasonDisplay = document.getElementById('reason-display');

        if (reasonButton && reasonDisplay) {
            const reasons = [
                "Em yêu chị Vì nụ cười của chị làm em vui cả ngày.",
                "Em yêu chị Vì chị luôn ở bên cạnh em những lúc khó khăn.",
                "Em yêu chị Vì cách chị quan tâm đến em thật đặc biệt.",
                "Em yêu chị Vì chị là người con gái tuyệt vời nhất em từng gặp.",
                "Em yêu chị Vì ánh mắt của chị luôn làm em xao xuyến.",
                "Em yêu chị Vì chị luôn tin tưởng và ủng hộ em.",
                "Em yêu chị Vì mỗi ngày ở bên chị đều là một ngày hạnh phúc.",
                "Em yêu chị Vì đơn giản hơn vì đó là chị người con gái em thương.",
                "EM yêu chị Vì yêu đơn giản là vì yêu thôi ❤️. Và đơn giản hơn nữa vì đó là chị người con gái em thương.",
            ];

            const initialIndex = Math.floor(Math.random() * reasons.length);
            reasonDisplay.textContent = reasons[initialIndex];

            reasonButton.addEventListener('click', function() {
                reasonDisplay.classList.add('fade');
                setTimeout(function() {
                    const randomIndex = Math.floor(Math.random() * reasons.length);
                    reasonDisplay.textContent = reasons[randomIndex];
                    reasonDisplay.classList.remove('fade');
                }, 500);
            });
        } else {
            console.warn("Reason elements not found.");
        }

        // --- 3. Code cho nút điều khiển YouTube Player ---
        const volumeButton = document.getElementById('volume-toggle');
        if (volumeButton) {
            volumeButton.addEventListener('click', function() {
                if (!player || typeof player.playVideo !== 'function') {
                    console.warn("Player is not ready yet or does not exist.");
                    return;
                }
                if (!isPlayerStarted) {
                    player.playVideo();
                    player.unMute();
                    volumeButton.textContent = '🔊';
                    isMuted = false;
                    isPlayerStarted = true;
                } else {
                    if (isMuted) {
                        player.unMute();
                        volumeButton.textContent = '🔊';
                        isMuted = false;
                    } else {
                        player.mute();
                        volumeButton.textContent = '🔇';
                        isMuted = true;
                    }
                }
            });
        } else {
            console.warn("Volume toggle button not found.");
        }

        // --- 4. Code cho chức năng "Mở quà 20-10" ---
        const giftButton = document.getElementById('gift-button');
        const giftModal = document.getElementById('giftModal'); // Check ID here

        if (giftButton && giftModal) {
            const closeModalButton = giftModal.querySelector('.close-modal-button'); // Find button *inside* modal

            if (!closeModalButton) {
                console.error("Close button for gift modal not found INSIDE the modal.");
            } else {
                giftButton.addEventListener('click', () => {
                    giftModal.style.display = 'flex';
                });

                closeModalButton.addEventListener('click', () => {
                    giftModal.style.display = 'none';
                });

                giftModal.addEventListener('click', (event) => {
                    if (event.target === giftModal) {
                        giftModal.style.display = 'none';
                    }
                });

                document.addEventListener('keydown', function(event) {
                    if (event.key === "Escape" && giftModal.style.display === 'flex') {
                        giftModal.style.display = 'none';
                    }
                });
            } // End if closeModalButton exists
        } else {
            if (!giftButton) console.warn("Gift button not found.");
            if (!giftModal) console.warn("Gift modal element (id='giftModal') not found.");
        }
    }); // End DOMContentLoaded
</script>

<div class="youtube-player-hidden">
    <iframe id="youtube-player" src="https://www.youtube.com/embed/EFJ7kDjwI6w?autoplay=1&loop=1&playlist=EFJ7kDjwI6w&controls=0&mute=1&enablejsapi=1" frameborder="0" allow="autoplay; encrypted-media"></iframe>
</div>
<div id="giftModal" class="modal">
    <div class="modal-content">
        <span class="close-modal-button">&times;</span>
        <h2>Chúc mừng ngày 20-10!</h2>
        <img th:src="@{/img/gift-image.jpg}" alt="Quà tặng 20-10" class="gift-image">
        <p class="gift-message">Chúc chị một ngày thật vui vẻ, xinh đẹp và luôn ngập tràn hạnh phúc. Em yêu chị rất nhiều!</p>
    </div>
</div>
</body>
</html>